name: "build-dependency"

trigger:
  branches:
    include:
      - master
  paths:
    include:
      - food-calc/*

pool:
  vmImage: "ubuntu-20.04"

variables:
  proj: "M05-DependencyManagement"
  feed: food
  folder: "food-calc"
  dotnetSdkVersion: "6.x"
  buildConfiguration: "Release"

stages:
- stage: "BuildToFeed"
  jobs:
  - job: "BuildToFeed"
    displayName: "Build to Feed"
    steps:
      - task: UseDotNet@2
        displayName: "Use .NET Core SDK $(dotnetSdkVersion)"
        inputs:
          version: "$(dotnetSdkVersion)"
      
      - task: gitversion/setup@0
        inputs:
          versionSpec: '5.x'

      - task: gitversion/execute@0
        inputs:
          updateAssemblyInfo: true

      - task: DotNetCoreCLI@2
        displayName: "Restore project dependencies"
        inputs:
          command: "restore"
          projects: "$(folder)/food-calc.csproj"

      - task: DotNetCoreCLI@2
        displayName: "Build the project - $(buildConfiguration)"
        inputs:
          command: "build"
          arguments: "--no-restore --configuration $(buildConfiguration) -p:Version=$(GitVersion.SemVer)"
          projects: "$(folder)/food-calc.csproj"

      - task: DotNetCoreCLI@2
        inputs:
          command: 'pack'
          packagesToPack: '$(folder)/food-calc.csproj'
          versioningScheme: 'byEnvVar'
          versionEnvVar: 'GitVersion.SemVer'
        displayName: Create nuget package

      - task: NuGetCommand@2
        displayName: Publish nuget package
        inputs:
          command: push
          publishVstsFeed: "$(proj)/$(feed)"
          allowPackageConflicts: true
name: "build-dependency"

trigger:
  branches:
    include:
      - master
  paths:
    include:
      - food-calc/*

pool:
  vmImage: "ubuntu-20.04"

variables:
  proj: "az-400"
  feed: foodapp
  folder: "food-calc"
  dotnetSdkVersion: "6.x"
  buildConfiguration: "Release"

stages:
- stage: "BuildToFeed"
  jobs:
  - job: "BuildToFeed"
    displayName: "Build to Feed"
    steps:
      - task: UseDotNet@2
        displayName: "Use .NET Core SDK $(dotnetSdkVersion)"
        inputs:
          version: "$(dotnetSdkVersion)"
      
      # - task: gitversion/setup@0
      #   inputs:
      #     versionSpec: '5.x'

      # - task: gitversion/execute@0
      #   inputs:
      #     updateAssemblyInfo: true

      - task: DotNetCoreCLI@2
        displayName: "Restore project dependencies"
        inputs:
          command: "restore"
          projects: "$(folder)/food-calc.csproj"

      - task: DotNetCoreCLI@2
        displayName: "Build the project - $(buildConfiguration)"
        inputs:
          command: "build"
          arguments: "--no-restore --configuration $(buildConfiguration)"
          projects: "$(folder)/food-calc.csproj"

      - task: DotNetCoreCLI@2
        inputs:
          command: 'pack'
          packagesToPack: '$(folder)/food-calc.csproj'
        displayName: Create nuget package

      - task: NuGetCommand@2
        displayName: Publish nuget package
        inputs:
          command: 'push'
          packagesToPush: '$(Build.ArtifactStagingDirectory)/**/*.nupkg;!$(Build.ArtifactStagingDirectory)/**/*.symbols.nupkg'
          nuGetFeedType: 'internal'
          publishVstsFeed: 'ee4ab352-fae2-4c2f-91b0-815e3a8ff35e/6b20b336-4812-43b9-a990-c5ea6ae0ac19'
          allowPackageConflicts: true